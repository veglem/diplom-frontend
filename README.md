# SubMe Frontend

Фронтенд-часть платформы для создателей контента, позволяющая авторам монетизировать свой контент через систему подписок и пожертвований.

## Технологический стек

- **React** + **TypeScript**
- **Material-UI (MUI)** для компонентов интерфейса
- **React Router** для маршрутизации
- **Emotion** для стилизации
- Адаптивный дизайн с поддержкой мобильных и десктопных устройств

## Архитектура приложения

### Основные концепции

1. **Адаптивный дизайн**
   - Использует DeviceContext для определения типа устройства
   - Отдельные лейауты для мобильных (MobileLayout) и десктопных (DesktopLayout) устройств
   - Компонент DeviceRenderer для условного рендеринга интерфейса

2. **Темизация**
   - Поддержка светлой и темной темы
   - Настройки темы хранятся в localStorage
   - Контекст ThemePaletteModeContext для управления темой

3. **Авторизация**
   - Защищенные маршруты через компонент ProtectedRoute
   - Контекст AuthContext для управления состоянием авторизации
   - Модальные окна для логина и регистрации

### Основные роли пользователей

1. **Обычный пользователь**
   - Может просматривать контент
   - Может подписываться на авторов
   - Имеет доступ к базовым настройкам профиля

2. **Автор (Writer)**
   - Расширенный профиль с описанием и целями
   - Может создавать посты
   - Может настраивать уровни подписки
   - Имеет доступ к статистике и монетизации

## Моковая база данных

В проекте используется in-memory база данных (src/utils/databaseMock.ts) вместо реального API. Основные сущности:

- **User** - данные пользователя
- **Creator** - данные автора
- **Subscription** - уровни подписки
- **Post** - публикации
- **Comment** - комментарии
- **Statistics** - статистика авторов
- **Attachment** - медиа-файлы, прикрепленные к постам

### Особенности работы с моковой БД

- Все сервисы (userService, writerService) работают через единый экземпляр БД
- БД поддерживает основные CRUD операции
- Реализована базовая статистика для авторов
- TODO комментарии в сервисах указывают на планируемые эндпоинты реального API

## Основные компоненты

### Компоненты авторизации
- `LoginModal` - модальное окно входа
- `RegisterModal` - модальное окно регистрации
- `ProtectedRoute` - компонент для защиты маршрутов

### Настройки пользователя
- `UserSettingsTab` - вкладки настроек
- `ProfileSettings` - настройки профиля
- `NotificationSettings` - настройки уведомлений
- `CustomizationSettings` - настройки интерфейса
- `PasswordChangeModal` - смена пароля

### Компоненты автора
- `WriterProfilePage` - страница профиля автора
- `BecomeAuthorModal` - модальное окно для становления автором
- `PostEditor` - редактор постов с поддержкой медиа-контента
- `PostEditorModal` - модальное окно для создания и редактирования постов
- `PostCard` - компонент для отображения поста с медиа-контентом
- `SubscriptionLevelCard` - карточка уровня подписки

### Общие компоненты
- `HeadImage` - компонент для отображения обложки
- `BaseAvatar` - базовый компонент аватара
- `ImageCropModal` - модальное окно для обрезки изображений

## Маршрутизация

Основные маршруты:
- `/` - главная страница
- `/subscribtions` - страница подписок (защищенный)
- `/writer-profile` - профиль автора (защищенный)
- `/author/:author_id` - публичный профиль автора
- `/settings/*` - настройки пользователя (защищенный)
  - `/settings/profile`
  - `/settings/notifications`
  - `/settings/customization`

## Особенности реализации

1. **Адаптивность**
   - Определение типа устройства через DeviceContext
   - Разные лейауты для разных устройств
   - Адаптивные компоненты

2. **Управление состоянием**
   - Использование React Context для глобального состояния
   - Локальное состояние для UI компонентов
   - Моковая БД для имитации бэкенда

3. **Обработка изображений**
   - Поддержка загрузки изображений
   - Встроенный редактор для обрезки
   - Отдельные компоненты для аватара и обложки

4. **Монетизация**
   - Система подписок с разными уровнями
   - Поддержка целей финансирования
   - Статистика для авторов

5. **Поддержка медиа-контента**
   - Загрузка и отображение изображений и видео в постах
   - Предпросмотр загруженных файлов в редакторе
   - Адаптивная галерея для отображения медиа-контента
   - Встроенный видеоплеер для просмотра видео

## Структура проекта

```
src/
├── components/           # Компоненты React
│   ├── Auth/            # Компоненты аутентификации
│   ├── Avatar/          # Компоненты для аватаров
│   ├── Goal/            # Компоненты для целей финансирования
│   ├── HeadImage/       # Компоненты для обложек профилей
│   ├── Post/            # Компоненты для работы с постами
│   ├── SubscriptionCard/# Компоненты подписок
│   └── UserSettings/    # Компоненты настроек пользователя
│
├── contexts/            # React контексты
│   ├── AuthContext.tsx  # Контекст авторизации
│   └── ...
│
├── layouts/             # Компоненты лейаутов
│   ├── BaseLayout.tsx   # Базовый лейаут
│   ├── DesktopLayout.tsx# Лейаут для десктопов
│   └── MobileLayout.tsx # Лейаут для мобильных
│
├── pages/               # Компоненты страниц
│   ├── HomePage.tsx     # Главная страница
│   ├── UserSettingsPage.tsx # Страница настроек
│   └── WriterProfilePage.tsx# Страница профиля автора
│
├── services/            # Сервисы для работы с данными
│   ├── userService.ts   # Сервис пользователя
│   └── writerService.ts # Сервис автора
│
├── types/               # TypeScript типы
│   └── user.ts         # Типы пользователей
│
├── utils/               # Утилиты
│   ├── db.ts           # Инициализация БД
│   ├── databaseMock.ts # Моковая БД
│   ├── deviceDetection.ts # Определение устройства
│   └── DeviceContext.tsx  # Контекст устройства
│
├── App.tsx             # Корневой компонент
├── main.tsx            # Точка входа
└── theme.ts            # Настройки темы
```

### Ключевые особенности организации

1. **Компонентный подход**
   - Компоненты сгруппированы по функциональности
   - Каждый компонент в отдельной директории с сопутствующими файлами
   - Переиспользуемые компоненты в общей директории components

2. **Разделение ответственности**
   - Бизнес-логика в сервисах
   - UI логика в компонентах
   - Общая логика в утилитах
   - Типы данных в отдельной директории

3. **Масштабируемость**
   - Модульная структура
   - Четкое разделение компонентов по назначению
   - Возможность легкого добавления новых модулей

## Дальнейшее развитие

1. Замена моковой БД на реальный API
2. Добавление реального механизма загрузки файлов
3. Реализация системы уведомлений
4. Улучшение статистики для авторов
5. Добавление поиска и фильтрации контента

## Контексты для работы с писателями и постами

### WriterContext

Контекст для работы с данными писателя и его постами:

- Принимает в пропсах ID писателя (`writerId`)
- Загружает профиль писателя и ID его постов (вместо полных постов)
- Предоставляет информацию о количестве подписчиков
- Определяет, является ли текущий пользователь этим писателем
- Определяет, подписан ли текущий пользователь на писателя
- Предоставляет методы для работы с профилем:
  - `updateWriterProfile` - обновление имени и описания
  - `updateWriterAvatar` - обновление аватара
  - `updateWriterCover` - обновление обложки профиля
  - `updateWriterGoal` - обновление цели финансирования
  - `createPost` - создание нового поста (с поддержкой атачей)
  - `refreshPosts` - обновление списка постов
  - `followWriter` - подписаться на писателя
  - `unfollowWriter` - отписаться от писателя

Пример использования:
```tsx
<WriterProvider writerId="writer-123">
  <WriterProfileComponent />
  <WriterPostsList />
</WriterProvider>
```

### PostContext

Контекст для работы с отдельным постом:

- Принимает в пропсах ID поста (`postId`)
- Загружает данные поста, ID атачей и ID комментариев
- Определяет, является ли текущий пользователь автором поста
- Проверяет доступность поста для текущего пользователя
- Для недоступных постов скрывает содержимое (показывает только заголовок)
- Предоставляет методы для работы с постом:
  - `updatePost` - обновление заголовка и содержимого
  - `deletePost` - удаление поста
  - `refreshAttachments` - обновление списка атачей
  - `refreshComments` - обновление списка комментариев
  - `likePost` - поставить лайк посту
  - `unlikePost` - убрать лайк с поста
  - `addComment` - добавить комментарий
  - `deleteComment` - удалить комментарий
  - `likeComment` - поставить лайк комментарию
  - `unlikeComment` - убрать лайк с комментария
  - `isCommentLiked` - проверить, поставил ли пользователь лайк комментарию

Пример использования:
```tsx
<WriterProvider writerId="writer-123">
  <PostProvider postId="post-456">
    <PostComponent />
  </PostProvider>
</WriterProvider>
```

### Особенности реализации

1. **Вложенность контекстов**
   - PostContext может быть вложен в WriterContext
   - Оба контекста используют AuthContext для проверки прав доступа

2. **Проверка прав доступа**
   - WriterContext проверяет, является ли текущий пользователь писателем
   - PostContext проверяет, является ли текущий пользователь автором поста
   - Методы редактирования доступны только авторам

3. **Управление доступом к контенту**
   - Для недоступных постов показывается только заголовок
   - Содержимое поста скрывается, если пользователь не имеет доступа

4. **Интеграция с сервисами**
   - Контексты используют writerService для работы с данными
   - При изменении данных обновляется как локальное состояние, так и данные в БД

5. **Социальные взаимодействия**
   - Поддержка лайков для постов и комментариев
   - Возможность подписки на писателей
   - Комментирование постов с поддержкой лайков

## Реализация поддержки медиа-контента

### Компоненты для работы с медиа-контентом

1. **PostEditor**
   - Добавлены кнопки для загрузки изображений и видео
   - Реализован предпросмотр загруженных файлов с возможностью удаления
   - Добавлена поддержка множественной загрузки файлов
   - Интеграция с TipTap для редактирования текста

2. **PostEditorModal**
   - Добавлено состояние для хранения аттачей
   - Изменен интерфейс onSave для передачи аттачей (title, content, attachments)
   - Реализована очистка состояния при закрытии модального окна

3. **PostCard**
   - Добавлено отображение аттачей (изображений и видео)
   - Реализована адаптивная галерея для отображения медиа-контента
   - Добавлен встроенный видеоплеер для просмотра видео

### Типы данных

Расширен тип Post:
```typescript
export interface Post {
  id: string;
  title: string;
  content: string;
  authorId: string;
  attachment_ids?: string[];
  attachment_types?: string[];
}
```

### Интеграция с контекстами

1. **WriterContext**
   - Метод createPost принимает аттачи (title, content, attachments)
   - Загружает аттачи в базу данных и связывает их с постом

2. **PostContext**
   - Загружает аттачи поста и предоставляет их через attachmentIds
   - Метод refreshAttachments для обновления списка аттачей

### Особенности реализации

1. **Предпросмотр файлов**
   - Использование URL.createObjectURL для создания превью
   - Автоматическое освобождение ресурсов при удалении файла

2. **Определение типа контента**
   - Автоматическое определение типа файла (изображение или видео)
   - Отображение соответствующего компонента в зависимости от типа

3. **Адаптивность**
   - Галерея адаптируется под размер экрана
   - Разное количество колонок для разных размеров экрана

4. **Интеграция с WriterProfilePage**
   - Использование контекстов вместо прямых вызовов сервисов
   - Компонент PostCardWithContext для работы с PostContext
